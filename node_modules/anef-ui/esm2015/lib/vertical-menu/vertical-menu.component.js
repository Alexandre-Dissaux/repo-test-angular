/**
 * @fileoverview added by tsickle
 * Generated from: lib/vertical-menu/vertical-menu.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Input, HostListener } from '@angular/core';
/**
 * @record
 */
export function VMenuItem() { }
if (false) {
    /** @type {?|undefined} */
    VMenuItem.prototype.items;
    /** @type {?|undefined} */
    VMenuItem.prototype.control;
}
export class VerticalMenuComponent {
    constructor() {
        this.topOffset = 0;
        this.isWithMarkers = false;
        this.isSingleLevel = true;
        this.targets = [];
    }
    /**
     * @return {?}
     */
    handleScroll() {
        if (!this.targets.length) {
            return;
        }
        /** @type {?} */
        const pos = (document.documentElement.scrollTop || document.body.scrollTop);
        /** @type {?} */
        let toActivate = this.targets[0];
        for (const elem of this.targets) {
            /** @type {?} */
            const threshold = this._getYOffset(elem.target) - 1;
            if (threshold <= pos) {
                toActivate = elem;
            }
            elem.expanded = false;
        }
        if (toActivate) {
            toActivate.expanded = true;
        }
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.formattedItems = this._parseItems(this.items);
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (changes.items && changes.items.previousValue != changes.items.currentValue) {
            this.formattedItems = this._parseItems(changes.items.currentValue);
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onAnchorLink(event) {
        // Scroll to the target adding the offset if defined
        /** @type {?} */
        const y = this._getYOffset(event.item.target);
        window.scrollTo({ top: y, behavior: 'smooth' });
    }
    /**
     * @private
     * @param {?} target
     * @return {?}
     */
    _getYOffset(target) {
        /** @type {?} */
        const targetElem = document.querySelector(target);
        if (!targetElem) {
            // In case the target element is unreachable we return a value superior to the max-scroll so it can't be auto-selected
            return document.documentElement.scrollHeight + 1;
        }
        /** @type {?} */
        const y = targetElem.getBoundingClientRect().top + window.pageYOffset - this.topOffset;
        return y;
    }
    /**
     * @private
     * @param {?} items
     * @return {?}
     */
    _parseItems(items) {
        if (!items) {
            return;
        }
        /** @type {?} */
        const formatted = [];
        for (const item of items) {
            /** @type {?} */
            const tmpItem = Object.assign({}, item);
            // Set onclick event if not defined and an id is passed as target
            if (item.target && item.target.indexOf('#') !== -1 && !item.command) {
                tmpItem.command = this.onAnchorLink.bind(this);
                this.targets.push(tmpItem);
            }
            // Status marker specific controls
            if (this.isWithMarkers) {
                if (!tmpItem.icon) {
                    tmpItem.icon = 'fa fa-check-circle';
                }
                if (item.control) {
                    delete tmpItem.control;
                    if (!tmpItem.styleClass) {
                        tmpItem.styleClass = '';
                    }
                    this.setMarkerStatus(tmpItem, item.control);
                    item.control.statusChanges.subscribe((/**
                     * @param {?} status
                     * @return {?}
                     */
                    (status) => {
                        this.setMarkerStatus(tmpItem, item.control);
                    }));
                }
            }
            // Recurse
            if (item.items && item.items.length) {
                this.isSingleLevel = false;
                tmpItem.items = this._parseItems((/** @type {?} */ (item.items)));
            }
            formatted.push(tmpItem);
        }
        return formatted;
    }
    /**
     * @param {?} item
     * @param {?} control
     * @return {?}
     */
    setMarkerStatus(item, control) {
        /** @type {?} */
        const isCompleteValidClass = 'is-complete-valid';
        /** @type {?} */
        const isCompleteInvalidClass = 'is-complete-invalid';
        /** @type {?} */
        const completeWithRejectionErrorKey = 'completeInvalid';
        if (control.valid) {
            this.addClass(item, isCompleteValidClass);
            this.removeClass(item, isCompleteInvalidClass);
        }
        else {
            if (control.errors && completeWithRejectionErrorKey in control.errors) {
                this.addClass(item, isCompleteInvalidClass);
            }
            else {
                this.removeClass(item, isCompleteInvalidClass);
            }
            this.removeClass(item, isCompleteValidClass);
        }
    }
    /**
     * @private
     * @param {?} item
     * @param {?} className
     * @return {?}
     */
    addClass(item, className) {
        if (!item.styleClass) {
            item.styleClass = className;
        }
        if (-1 === item.styleClass.indexOf(className)) {
            item.styleClass += ` ${className}`;
        }
    }
    /**
     * @private
     * @param {?} item
     * @param {?} className
     * @return {?}
     */
    removeClass(item, className) {
        item.styleClass = item.styleClass.replace(className, '').trim();
    }
}
VerticalMenuComponent.decorators = [
    { type: Component, args: [{
                // tslint:disable-next-line: component-selector
                selector: 'anef-vertical-menu',
                template: "<p-panelMenu\n  [model]=\"formattedItems\"\n  [multiple]=\"multiple\"\n  [style]=\"style\"\n  [styleClass]=\"styleClass\"\n  class=\"anef-ui-vmenu\"\n  [class.no-submenu]=\"isSingleLevel\"\n  [class.with-markers]=\"isWithMarkers\"\n  routerLinkActiveOptions=\"{exact: true}\"\n  ></p-panelMenu>\n",
                styles: [""]
            }] }
];
VerticalMenuComponent.propDecorators = {
    items: [{ type: Input }],
    style: [{ type: Input }],
    styleClass: [{ type: Input }],
    multiple: [{ type: Input }],
    topOffset: [{ type: Input }],
    isWithMarkers: [{ type: Input }],
    handleScroll: [{ type: HostListener, args: ['window:scroll',] }]
};
if (false) {
    /** @type {?} */
    VerticalMenuComponent.prototype.items;
    /** @type {?} */
    VerticalMenuComponent.prototype.style;
    /** @type {?} */
    VerticalMenuComponent.prototype.styleClass;
    /** @type {?} */
    VerticalMenuComponent.prototype.multiple;
    /** @type {?} */
    VerticalMenuComponent.prototype.topOffset;
    /** @type {?} */
    VerticalMenuComponent.prototype.isWithMarkers;
    /** @type {?} */
    VerticalMenuComponent.prototype.isSingleLevel;
    /** @type {?} */
    VerticalMenuComponent.prototype.formattedItems;
    /** @type {?} */
    VerticalMenuComponent.prototype.targets;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVydGljYWwtbWVudS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmVmLXVpLyIsInNvdXJjZXMiOlsibGliL3ZlcnRpY2FsLW1lbnUvdmVydGljYWwtbWVudS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBVSxZQUFZLEVBQTRCLE1BQU0sZUFBZSxDQUFDOzs7O0FBSWpHLCtCQUdDOzs7SUFGQywwQkFBZ0Q7O0lBQ2hELDRCQUEwQjs7QUFTNUIsTUFBTSxPQUFPLHFCQUFxQjtJQU5sQztRQVlXLGNBQVMsR0FBRyxDQUFDLENBQUM7UUFDZCxrQkFBYSxHQUFHLEtBQUssQ0FBQztRQUUvQixrQkFBYSxHQUFHLElBQUksQ0FBQztRQUVyQixZQUFPLEdBQWUsRUFBRSxDQUFDO0lBMEgzQixDQUFDOzs7O0lBdkhDLFlBQVk7UUFDVixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUU7WUFBRSxPQUFPO1NBQUU7O2NBRS9CLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsU0FBUyxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDOztZQUN2RSxVQUFVLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDaEMsS0FBSyxNQUFNLElBQUksSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFOztrQkFDekIsU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUM7WUFDbkQsSUFBSSxTQUFTLElBQUksR0FBRyxFQUFFO2dCQUNwQixVQUFVLEdBQUcsSUFBSSxDQUFDO2FBQ25CO1lBQ0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7U0FDdkI7UUFDRCxJQUFJLFVBQVUsRUFBRTtZQUNkLFVBQVUsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1NBQzVCO0lB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LFNBQVMsRUFBRSxDQUFDO1NBQ3BDO0lBQ0gsQ0FBQzs7Ozs7OztJQUVPLFdBQVcsQ0FBQyxJQUFjLEVBQUUsU0FBaUI7UUFDbkQsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDbEUsQ0FBQzs7O1lBMUlGLFNBQVMsU0FBQzs7Z0JBRVQsUUFBUSxFQUFFLG9CQUFvQjtnQkFDOUIsb1RBQTZDOzthQUU5Qzs7O29CQUdFLEtBQUs7b0JBQ0wsS0FBSzt5QkFDTCxLQUFLO3VCQUNMLEtBQUs7d0JBQ0wsS0FBSzs0QkFDTCxLQUFLOzJCQU1MLFlBQVksU0FBQyxlQUFlOzs7O0lBWDdCLHNDQUE0Qjs7SUFDNUIsc0NBQW9COztJQUNwQiwyQ0FBNEI7O0lBQzVCLHlDQUEyQjs7SUFDM0IsMENBQXVCOztJQUN2Qiw4Q0FBK0I7O0lBRS9CLDhDQUFxQjs7SUFDckIsK0NBQTJCOztJQUMzQix3Q0FBeUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBPbkluaXQsIEhvc3RMaXN0ZW5lciwgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQge01lbnVJdGVtfSBmcm9tICdwcmltZW5nL2FwaSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVk1lbnVJdGVtIGV4dGVuZHMgTWVudUl0ZW0ge1xuICBpdGVtcz86IE1lbnVJdGVtW10gfCBNZW51SXRlbVtdW10gfCBWTWVudUl0ZW1bXTtcbiAgY29udHJvbD86IEFic3RyYWN0Q29udHJvbDtcbn1cblxuQENvbXBvbmVudCh7XG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogY29tcG9uZW50LXNlbGVjdG9yXG4gIHNlbGVjdG9yOiAnYW5lZi12ZXJ0aWNhbC1tZW51JyxcbiAgdGVtcGxhdGVVcmw6ICcuL3ZlcnRpY2FsLW1lbnUuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi92ZXJ0aWNhbC1tZW51LmNvbXBvbmVudC5jc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBWZXJ0aWNhbE1lbnVDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XG5cbiAgQElucHV0KCkgaXRlbXM6IFZNZW51SXRlbVtdO1xuICBASW5wdXQoKSBzdHlsZTogYW55O1xuICBASW5wdXQoKSBzdHlsZUNsYXNzOiBzdHJpbmc7XG4gIEBJbnB1dCgpIG11bHRpcGxlOiBib29sZWFuO1xuICBASW5wdXQoKSB0b3BPZmZzZXQgPSAwO1xuICBASW5wdXQoKSBpc1dpdGhNYXJrZXJzID0gZmFsc2U7XG5cbiAgaXNTaW5nbGVMZXZlbCA9IHRydWU7XG4gIGZvcm1hdHRlZEl0ZW1zOiBNZW51SXRlbVtdO1xuICB0YXJnZXRzOiBNZW51SXRlbVtdID0gW107XG5cbiAgQEhvc3RMaXN0ZW5lcignd2luZG93OnNjcm9sbCcpXG4gIGhhbmRsZVNjcm9sbCgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMudGFyZ2V0cy5sZW5ndGgpIHsgcmV0dXJuOyB9XG5cbiAgICBjb25zdCBwb3MgPSAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCB8fCBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcCk7XG4gICAgbGV0IHRvQWN0aXZhdGUgPSB0aGlzLnRhcmdldHNbMF07XG4gICAgZm9yIChjb25zdCBlbGVtIG9mIHRoaXMudGFyZ2V0cykge1xuICAgICAgY29uc3QgdGhyZXNob2xkID0gdGhpcy5fZ2V0WU9mZnNldChlbGVtLnRhcmdldCkgLSAxO1xuICAgICAgaWYgKHRocmVzaG9sZCA8PSBwb3MpIHtcbiAgICAgICAgdG9BY3RpdmF0ZSA9IGVsZW07XG4gICAgICB9XG4gICAgICBlbGVtLmV4cGFuZGVkID0gZmFsc2U7XG4gICAgfVxuICAgIGlmICh0b0FjdGl2YXRlKSB7XG4gICAgICB0b0FjdGl2YXRlLmV4cGFuZGVkID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmZvcm1hdHRlZEl0ZW1zID0gdGhpcy5fcGFyc2VJdGVtcyh0aGlzLml0ZW1zKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoY2hhbmdlcy5pdGVtcyAmJiBjaGFuZ2VzLml0ZW1zLnByZXZpb3VzVmFsdWUgIT0gY2hhbmdlcy5pdGVtcy5jdXJyZW50VmFsdWUpIHtcbiAgICAgIHRoaXMuZm9ybWF0dGVkSXRlbXMgPSB0aGlzLl9wYXJzZUl0ZW1zKGNoYW5nZXMuaXRlbXMuY3VycmVudFZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgb25BbmNob3JMaW5rKGV2ZW50KTogdm9pZCB7XG4gICAgLy8gU2Nyb2xsIHRvIHRoZSB0YXJnZXQgYWRkaW5nIHRoZSBvZmZzZXQgaWYgZGVmaW5lZFxuICAgIGNvbnN0IHkgPSB0aGlzLl9nZXRZT2Zmc2V0KGV2ZW50Lml0ZW0udGFyZ2V0KTtcbiAgICB3aW5kb3cuc2Nyb2xsVG8oe3RvcDogeSwgYmVoYXZpb3I6ICdzbW9vdGgnfSk7XG4gIH1cblxuICBwcml2YXRlIF9nZXRZT2Zmc2V0KHRhcmdldDogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBjb25zdCB0YXJnZXRFbGVtID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcih0YXJnZXQpO1xuICAgIGlmICghdGFyZ2V0RWxlbSkge1xuICAgICAgLy8gSW4gY2FzZSB0aGUgdGFyZ2V0IGVsZW1lbnQgaXMgdW5yZWFjaGFibGUgd2UgcmV0dXJuIGEgdmFsdWUgc3VwZXJpb3IgdG8gdGhlIG1heC1zY3JvbGwgc28gaXQgY2FuJ3QgYmUgYXV0by1zZWxlY3RlZFxuICAgICAgcmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxIZWlnaHQgKyAxO1xuICAgIH1cbiAgICBjb25zdCB5ID0gdGFyZ2V0RWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3AgKyB3aW5kb3cucGFnZVlPZmZzZXQgLSB0aGlzLnRvcE9mZnNldDtcbiAgICByZXR1cm4geTtcbiAgfVxuXG4gIHByaXZhdGUgX3BhcnNlSXRlbXMoaXRlbXM6IFZNZW51SXRlbVtdKTogTWVudUl0ZW1bXSB7XG4gICAgaWYgKCFpdGVtcykgeyByZXR1cm47IH1cbiAgICBjb25zdCBmb3JtYXR0ZWQ6IE1lbnVJdGVtW10gPSBbXTtcblxuICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcykge1xuICAgICAgY29uc3QgdG1wSXRlbSA9IHsgLi4uaXRlbSB9O1xuXG4gICAgICAvLyBTZXQgb25jbGljayBldmVudCBpZiBub3QgZGVmaW5lZCBhbmQgYW4gaWQgaXMgcGFzc2VkIGFzIHRhcmdldFxuICAgICAgaWYgKGl0ZW0udGFyZ2V0ICYmIGl0ZW0udGFyZ2V0LmluZGV4T2YoJyMnKSAhPT0gLTEgJiYgIWl0ZW0uY29tbWFuZCkge1xuICAgICAgICB0bXBJdGVtLmNvbW1hbmQgPSB0aGlzLm9uQW5jaG9yTGluay5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLnRhcmdldHMucHVzaCh0bXBJdGVtKTtcbiAgICAgIH1cblxuICAgICAgLy8gU3RhdHVzIG1hcmtlciBzcGVjaWZpYyBjb250cm9sc1xuICAgICAgaWYgKHRoaXMuaXNXaXRoTWFya2Vycykge1xuICAgICAgICBpZiAoIXRtcEl0ZW0uaWNvbikge1xuICAgICAgICAgIHRtcEl0ZW0uaWNvbiA9ICdmYSBmYS1jaGVjay1jaXJjbGUnO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGl0ZW0uY29udHJvbCkge1xuICAgICAgICAgIGRlbGV0ZSB0bXBJdGVtLmNvbnRyb2w7XG5cbiAgICAgICAgICBpZiAoIXRtcEl0ZW0uc3R5bGVDbGFzcykge1xuICAgICAgICAgICAgdG1wSXRlbS5zdHlsZUNsYXNzID0gJyc7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdGhpcy5zZXRNYXJrZXJTdGF0dXModG1wSXRlbSwgaXRlbS5jb250cm9sKTtcblxuICAgICAgICAgIGl0ZW0uY29udHJvbC5zdGF0dXNDaGFuZ2VzLnN1YnNjcmliZSgoc3RhdHVzOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2V0TWFya2VyU3RhdHVzKHRtcEl0ZW0sIGl0ZW0uY29udHJvbCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gUmVjdXJzZVxuICAgICAgaWYgKGl0ZW0uaXRlbXMgJiYgaXRlbS5pdGVtcy5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5pc1NpbmdsZUxldmVsID0gZmFsc2U7XG4gICAgICAgIHRtcEl0ZW0uaXRlbXMgPSB0aGlzLl9wYXJzZUl0ZW1zKGl0ZW0uaXRlbXMgYXMgTWVudUl0ZW1bXSk7XG4gICAgICB9XG5cbiAgICAgIGZvcm1hdHRlZC5wdXNoKHRtcEl0ZW0pO1xuICAgIH1cblxuICAgIHJldHVybiBmb3JtYXR0ZWQ7XG4gIH1cblxuICBzZXRNYXJrZXJTdGF0dXMoaXRlbTogTWVudUl0ZW0sIGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCkge1xuICAgIGNvbnN0IGlzQ29tcGxldGVWYWxpZENsYXNzID0gJ2lzLWNvbXBsZXRlLXZhbGlkJztcbiAgICBjb25zdCBpc0NvbXBsZXRlSW52YWxpZENsYXNzID0gJ2lzLWNvbXBsZXRlLWludmFsaWQnO1xuICAgIGNvbnN0IGNvbXBsZXRlV2l0aFJlamVjdGlvbkVycm9yS2V5ID0gJ2NvbXBsZXRlSW52YWxpZCc7XG5cbiAgICBpZiAoY29udHJvbC52YWxpZCkge1xuICAgICAgdGhpcy5hZGRDbGFzcyhpdGVtLCBpc0NvbXBsZXRlVmFsaWRDbGFzcyk7XG4gICAgICB0aGlzLnJlbW92ZUNsYXNzKGl0ZW0sIGlzQ29tcGxldGVJbnZhbGlkQ2xhc3MpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoY29udHJvbC5lcnJvcnMgJiYgY29tcGxldGVXaXRoUmVqZWN0aW9uRXJyb3JLZXkgaW4gY29udHJvbC5lcnJvcnMpIHtcbiAgICAgICAgdGhpcy5hZGRDbGFzcyhpdGVtLCBpc0NvbXBsZXRlSW52YWxpZENsYXNzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMucmVtb3ZlQ2xhc3MoaXRlbSwgaXNDb21wbGV0ZUludmFsaWRDbGFzcyk7XG4gICAgICB9XG4gICAgICB0aGlzLnJlbW92ZUNsYXNzKGl0ZW0sIGlzQ29tcGxldGVWYWxpZENsYXNzKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkZENsYXNzKGl0ZW06IE1lbnVJdGVtLCBjbGFzc05hbWU6IHN0cmluZykge1xuICAgIGlmICghaXRlbS5zdHlsZUNsYXNzKSB7XG4gICAgICBpdGVtLnN0eWxlQ2xhc3MgPSBjbGFzc05hbWU7XG4gICAgfVxuICAgIGlmICgtMSA9PT0gaXRlbS5zdHlsZUNsYXNzLmluZGV4T2YoY2xhc3NOYW1lKSkge1xuICAgICAgaXRlbS5zdHlsZUNsYXNzICs9IGAgJHtjbGFzc05hbWV9YDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUNsYXNzKGl0ZW06IE1lbnVJdGVtLCBjbGFzc05hbWU6IHN0cmluZykge1xuICAgIGl0ZW0uc3R5bGVDbGFzcyA9IGl0ZW0uc3R5bGVDbGFzcy5yZXBsYWNlKGNsYXNzTmFtZSwgJycpLnRyaW0oKTtcbiAgfVxufVxuIl19